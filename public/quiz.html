<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Quiz - PetRewardHub</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="logo">PetRewardHub</a>
                <div class="nav-links">
                    <div id="userNav" style="display: none; align-items: center; gap: 1rem;">
                        <a href="offers.html" class="nav-link">Offers</a>
                        <a href="gifts.html" class="nav-link">Gifts</a>
                        <a href="claim.html" class="nav-link">Claim</a>
                        <div class="coin-badge">
                            üí∞ <span id="coinBadge">0</span>
                        </div>
                        <button id="logoutBtn" class="btn btn-secondary">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Quiz Section -->
    <section class="section">
        <div class="container">
            <div class="quiz-container">
                <h1 class="text-center mb-4">Pet Preferences Quiz</h1>
                <p class="text-center mb-4">Help us understand your pet preferences to personalize your experience!</p>
                
                <!-- Progress Bar -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Question <span id="currentQuestion">1</span> of 5</span>
                            <span id="petTypeDisplay"></span>
                        </div>
                        <div style="background: var(--gray-200); border-radius: 10px; height: 8px;">
                            <div id="progressBar" style="background: var(--gradient); height: 100%; border-radius: 10px; width: 20%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Quiz Question -->
                <div id="quizContent">
                    <div class="quiz-question">
                        <h2 id="questionText">Loading question...</h2>
                    </div>
                    
                    <div class="quiz-actions">
                        <button id="yesBtn" class="btn btn-primary" data-answer="Yes">Yes</button>
                        <button id="noBtn" class="btn btn-secondary" data-answer="No">No</button>
                        <button id="maybeBtn" class="btn btn-secondary" data-answer="Maybe">Maybe</button>
                    </div>
                </div>
                
                <!-- Completion Message -->
                <div id="completionMessage" class="text-center" style="display: none;">
                    <div class="card message-success">
                        <div class="card-body">
                            <h3>üéâ Quiz Complete!</h3>
                            <p>Thank you for completing the quiz! Redirecting to offers page where you can start earning coins...</p>
                            <div class="shimmer" style="height: 4px; width: 100%; border-radius: 2px; margin-top: 1rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-init.js"></script>
    <script src="app.js"></script>
    
    <script>
        // Quiz state
        let currentUser = null;
        let userPetType = '';
        let currentQuestionIndex = 0;
        let answers = [];
        
        // Pet-specific questions
        const petQuestions = {
            'Dog': [
                "Does your dog enjoy playing fetch?",
                "Do you prefer dry or wet food for your dog?",
                "Is your dog comfortable around other dogs?",
                "Do you take your dog for regular walks?",
                "Does your dog have any dietary restrictions?"
            ],
            'Cat': [
                "Does your cat enjoy playing with toys?",
                "Do you prefer indoor or outdoor access for your cat?",
                "Is your cat comfortable with being brushed?",
                "Does your cat use a scratching post?",
                "Does your cat have any specific dietary needs?"
            ],
            'Bird': [
                "Does your bird enjoy singing or talking?",
                "Do you provide a variety of perches?",
                "Is your bird comfortable with handling?",
                "Do you offer fresh fruits and vegetables?",
                "Does your bird get regular out-of-cage time?"
            ],
            'Rabbit': [
                "Does your rabbit have enough space to hop around?",
                "Do you provide unlimited hay?",
                "Is your rabbit litter trained?",
                "Do you offer fresh vegetables daily?",
                "Does your rabbit enjoy being petted?"
            ],
            'Fish': [
                "Do you perform regular water testing?",
                "Is your aquarium properly filtered?",
                "Do you provide a variety in diet?",
                "Is your tank appropriately sized?",
                "Do you monitor water temperature closely?"
            ],
            'Horse': [
                "Do you provide regular exercise?",
                "Is your horse comfortable with grooming?",
                "Do you offer quality hay and feed?",
                "Is your horse up to date on vaccinations?",
                "Do you provide regular hoof care?"
            ],
            'Ferret': [
                "Does your ferret get daily playtime?",
                "Do you provide a balanced ferret diet?",
                "Is your ferret litter trained?",
                "Do you ferret-proof your home?",
                "Does your ferret enjoy exploring?"
            ],
            'Reptile': [
                "Do you maintain proper temperature gradients?",
                "Is your enclosure appropriately sized?",
                "Do you provide UVB lighting if needed?",
                "Is your humidity level correct?",
                "Do you offer variety in diet?"
            ],
            'Small Mammal': [
                "Does your pet have enough space to exercise?",
                "Do you provide appropriate bedding?",
                "Is your pet's diet species-appropriate?",
                "Do you offer enrichment activities?",
                "Does your pet enjoy handling?"
            ]
        };

        // Default questions if pet type not found
        const defaultQuestions = [
            "Do you enjoy spending time with your pet?",
            "Is your pet active and playful?",
            "Do you provide regular veterinary care?",
            "Does your pet have any special needs?",
            "Do you enjoy buying toys and treats for your pet?"
        ];

        // Initialize quiz page
        async function initQuizPage() {
            try {
                // Wait for authentication
                currentUser = await app.requireAuth('index.html');
                
                // Check if user already completed quiz
                if (app.userData && app.userData.quizDone) {
                    window.location.href = 'offers.html';
                    return;
                }
                
                // Check if user selected pet first
                if (!app.userData || !app.userData.selectedPet) {
                    window.location.href = 'select-pet.html';
                    return;
                }
                
                // Setup header auth
                attachHeaderAuth();
                
                // Start the quiz
                startQuiz();
                
            } catch (error) {
                console.error('Initialization error:', error);
                window.location.href = 'index.html';
            }
        }

        // Start the quiz
        function startQuiz() {
            // Display pet type
            document.getElementById('petTypeDisplay').textContent = app.userData.selectedPet;
            
            // Get questions for the selected pet
            const questions = petQuestions[app.userData.selectedPet] || defaultQuestions;
            
            // Setup answer buttons
            setupAnswerButtons(questions);
            
            // Show first question
            showQuestion(questions, 0);
        }

        // Setup answer button handlers
        function setupAnswerButtons(questions) {
            const yesBtn = document.getElementById('yesBtn');
            const noBtn = document.getElementById('noBtn');
            const maybeBtn = document.getElementById('maybeBtn');
            
            const answerHandler = (answer) => {
                // Save answer
                answers.push({
                    question: questions[currentQuestionIndex],
                    answer: answer
                });
                
                // Move to next question or complete
                currentQuestionIndex++;
                
                if (currentQuestionIndex < questions.length) {
                    showQuestion(questions, currentQuestionIndex);
                } else {
                    completeQuiz();
                }
            };
            
            yesBtn.addEventListener('click', () => answerHandler('Yes'));
            noBtn.addEventListener('click', () => answerHandler('No'));
            maybeBtn.addEventListener('click', () => answerHandler('Maybe'));
        }

        // Show current question
        function showQuestion(questions, index) {
            const questionText = document.getElementById('questionText');
            const currentQuestionElem = document.getElementById('currentQuestion');
            const progressBar = document.getElementById('progressBar');
            
            // Update question text
            questionText.textContent = questions[index];
            
            // Update progress
            currentQuestionElem.textContent = index + 1;
            const progress = ((index + 1) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        // Complete the quiz
        async function completeQuiz() {
            const quizContent = document.getElementById('quizContent');
            const completionMessage = document.getElementById('completionMessage');
            
            // Hide quiz, show completion message
            quizContent.style.display = 'none';
            completionMessage.style.display = 'block';
            
            try {
                // Mark quiz as complete in Firestore
                const success = await app.completeQuiz();
                
                if (success) {
                    // Redirect to offers page after delay
                    setTimeout(() => {
                        window.location.href = 'offers.html';
                    }, 3000);
                } else {
                    throw new Error('Failed to save quiz completion');
                }
            } catch (error) {
                completionMessage.innerHTML = `
                    <div class="card message-error">
                        <div class="card-body">
                            <h3>‚ùå Error</h3>
                            <p>${error.message}. <a href="offers.html" class="btn btn-primary mt-2">Continue to offers</a></p>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initQuizPage);
    </script>
</body>
</html>