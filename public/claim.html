<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Gift - PetRewardHub</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="logo">PetRewardHub</a>
                <div class="nav-links">
                    <div id="userNav" style="display: none; align-items: center; gap: 1rem;">
                        <a href="offers.html" class="nav-link">Offers</a>
                        <a href="gifts.html" class="nav-link">Gifts</a>
                        <a href="claim.html" class="nav-link">Claim</a>
                        <div class="coin-badge">
                            üí∞ <span id="coinBadge">0</span>
                        </div>
                        <button id="logoutBtn" class="btn btn-secondary">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Claim Section -->
    <section class="section">
        <div class="container">
            <div style="max-width: 600px; margin: 0 auto;">
                <h1 class="text-center mb-4">Claim Your Gift</h1>
                
                <!-- Selected Gift Info -->
                <div id="selectedGiftInfo" class="card mb-4" style="display: none;">
                    <div class="card-body">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <img id="giftImage" src="" alt="Selected Gift" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                            <div>
                                <h3 id="giftName">Gift Name</h3>
                                <div class="gift-coins" id="giftCoins">0 Coins</div>
                                <p id="giftDescription" style="color: var(--gray-600); font-size: 0.9rem; margin: 0;"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Claim Form -->
                <form id="claimForm" class="card" style="padding: 2rem;">
                    <div class="form-group">
                        <label for="name" class="form-label">Full Name *</label>
                        <input type="text" id="name" class="form-input" required placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="email" class="form-label">Email Address *</label>
                        <input type="email" id="email" class="form-input" required placeholder="Enter your email address">
                    </div>
                    
                    <div class="form-group">
                        <label for="address" class="form-label">Shipping Address *</label>
                        <textarea id="address" class="form-textarea" required placeholder="Enter your complete shipping address including street, city, state, and zip code" rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone" class="form-label">Phone Number (Optional)</label>
                        <input type="tel" id="phone" class="form-input" placeholder="Enter your phone number for delivery updates">
                    </div>

                    <!-- Terms Agreement -->
                    <div class="form-group">
                        <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                            <input type="checkbox" id="termsAgree" required style="margin-top: 0.25rem;">
                            <label for="termsAgree" class="form-label" style="margin-bottom: 0;">
                                I agree to the <a href="#" style="color: var(--primary-blue);">Terms of Service</a> and confirm that the information provided is accurate. I understand that <span id="coinsToDeduct">0</span> coins will be deducted from my account upon submission.
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Submit Claim & Deduct Coins
                    </button>

                    <div id="formMessage" class="mt-3" style="display: none;"></div>
                </form>

                <!-- Important Information -->
                <div class="card mt-4" style="background: #f0f9ff; border-color: #7dd3fc;">
                    <div class="card-body">
                        <h4>üì¶ Shipping Information</h4>
                        <p>Please allow 2-3 weeks for processing and delivery. You will receive a confirmation email once your gift has been shipped. Make sure your shipping address is correct and complete.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-init.js"></script>
    <script src="app.js"></script>
    
    <script>
        let currentUser = null;
        let selectedGift = null;

        // Initialize claim page
        async function initClaimPage() {
            try {
                // Wait for authentication
                currentUser = await app.requireAuth('index.html');
                
                // Check if user completed previous steps
                if (!app.userData || !app.userData.selectedPet) {
                    window.location.href = 'select-pet.html';
                    return;
                }
                
                if (!app.userData.quizDone) {
                    window.location.href = 'quiz.html';
                    return;
                }
                
                // Setup header auth
                attachHeaderAuth();
                
                // Load selected gift
                loadSelectedGift();
                
                // Prefill user data
                prefillUserData();
                
            } catch (error) {
                console.error('Initialization error:', error);
                window.location.href = 'index.html';
            }
        }

        // Load selected gift from session storage
        function loadSelectedGift() {
            const giftData = sessionStorage.getItem('selectedGift');
            if (giftData) {
                selectedGift = JSON.parse(giftData);
                displaySelectedGift();
            } else {
                // No gift selected, redirect to gifts page
                window.location.href = 'gifts.html';
            }
        }

        // Display selected gift information
        function displaySelectedGift() {
            if (!selectedGift) return;

            const giftInfo = document.getElementById('selectedGiftInfo');
            const giftImage = document.getElementById('giftImage');
            const giftName = document.getElementById('giftName');
            const giftCoins = document.getElementById('giftCoins');
            const giftDescription = document.getElementById('giftDescription');
            const coinsToDeduct = document.getElementById('coinsToDeduct');

            giftImage.src = selectedGift.image;
            giftImage.alt = selectedGift.name;
            giftName.textContent = selectedGift.name;
            giftCoins.textContent = `${selectedGift.coins} Coins`;
            giftDescription.textContent = selectedGift.description;
            coinsToDeduct.textContent = selectedGift.coins;

            giftInfo.style.display = 'block';

            // Check if user has enough coins
            if (app.userData && app.userData.coins < selectedGift.coins) {
                document.getElementById('claimForm').innerHTML = `
                    <div class="message-error">
                        <h3>‚ùå Insufficient Coins</h3>
                        <p>You need ${selectedGift.coins} coins to claim this gift, but you only have ${app.userData.coins} coins.</p>
                        <p>Complete more offers on the <a href="offers.html">Offers page</a> to earn more coins!</p>
                        <a href="gifts.html" class="btn btn-primary mt-2">Back to Gifts</a>
                    </div>
                `;
            }
        }

        // Prefill user data in form
        function prefillUserData() {
            if (app.userData) {
                document.getElementById('name').value = app.userData.name || '';
                document.getElementById('email').value = app.userData.email || '';
            }
        }

        // Handle claim form submission
        document.getElementById('claimForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedGift) {
                alert('No gift selected. Please go back to the gifts page and select a gift.');
                return;
            }

            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value || 'Not provided'
            };

            // Validate form
            if (!formData.name || !formData.email || !formData.address) {
                alert('Please fill in all required fields.');
                return;
            }

            if (!document.getElementById('termsAgree').checked) {
                alert('Please agree to the Terms of Service to continue.');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const messageDiv = document.getElementById('formMessage');

            // Show loading state
            submitBtn.textContent = 'Processing Claim...';
            submitBtn.disabled = true;
            messageDiv.style.display = 'none';

            try {
                const result = await app.submitClaim(selectedGift, formData);
                
                if (result.success) {
                    messageDiv.innerHTML = `
                        <div class="message-success">
                            <h3>‚úÖ Claim Submitted Successfully!</h3>
                            <p>Your gift claim has been processed. ${selectedGift.coins} coins have been deducted from your account.</p>
                            <p>Redirecting to confirmation page...</p>
                        </div>
                    `;
                    messageDiv.style.display = 'block';

                    // Clear selected gift from session storage
                    sessionStorage.removeItem('selectedGift');

                    // Redirect to thank you page
                    setTimeout(() => {
                        window.location.href = 'thankyou.html';
                    }, 2000);

                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="message-error">
                        <h3>‚ùå Claim Failed</h3>
                        <p>Error: ${error.message}</p>
                        <p>Please try again or contact support if the problem persists.</p>
                    </div>
                `;
                messageDiv.style.display = 'block';
                
                submitBtn.textContent = 'Submit Claim & Deduct Coins';
                submitBtn.disabled = false;
            }
        });

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', initClaimPage);
    </script>
</body>
</html>